<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Asteroid Empire - STORM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #020617; font-family: sans-serif; touch-action: none; }
        canvas { display: block; }
        .no-select { user-select: none; -webkit-tap-highlight-color: transparent; }
        .weapon-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .weapon-card:hover { transform: translateY(-5px) scale(1.02); }
        .weapon-card.selected { border-color: #6366f1; background: rgba(99, 102, 241, 0.2); box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }
        #bossBarContainer { display: none; }
        #warningOverlay { display: none; pointer-events: none; }
        input[type=range] { accent-color: #6366f1; }
    </style>
</head>
<body class="no-select text-white">

    <canvas id="gameCanvas"></canvas>

    <!-- Warning Overlay -->
    <div id="warningOverlay" class="absolute inset-0 flex items-center justify-center bg-red-900/20 z-40 animate-pulse">
        <h2 class="text-6xl font-black text-red-500 italic tracking-tighter">BOSS APPROACHING</h2>
    </div>

    <!-- HUD -->
    <div id="hud" class="absolute top-0 left-0 w-full p-4 pointer-events-none flex flex-col items-center gap-2">
        <div id="bossBarContainer" class="w-full max-w-xl mb-2">
            <div class="text-center text-red-500 font-black text-xs uppercase tracking-widest mb-1">GOLIATH CLASS THREAT</div>
            <div class="w-full bg-slate-900/80 rounded-full h-4 border-2 border-red-900 overflow-hidden">
                <div id="bossBar" class="h-full bg-red-600 transition-all duration-100" style="width: 100%"></div>
            </div>
        </div>
        <div class="w-full max-w-md bg-slate-800/50 backdrop-blur rounded-full h-3 border border-slate-600 relative overflow-hidden">
            <div id="progressBar" class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-300" style="width: 0%"></div>
        </div>
        <div class="flex justify-between w-full max-w-md px-2">
            <div id="moneyDisplay" class="text-2xl font-black text-yellow-400 drop-shadow-md">$0</div>
            <div id="waveDisplay" class="text-xl font-black text-indigo-400 drop-shadow-md italic">WAVE 1</div>
        </div>
    </div>

    <!-- Main Menu -->
    <div id="menu" class="absolute inset-0 flex items-center justify-center bg-black/80 backdrop-blur-md z-50">
        <div class="bg-slate-900 p-8 rounded-[2.5rem] border border-indigo-500/50 w-full max-w-2xl text-center shadow-2xl">
            <div class="flex justify-between items-start mb-4">
                <div class="w-10"></div>
                <h1 class="text-7xl font-black italic tracking-tighter bg-gradient-to-b from-white to-indigo-400 bg-clip-text text-transparent">STORM</h1>
                <button onclick="window.toggleSettings()" class="p-2 bg-slate-800 rounded-full hover:bg-slate-700 transition-colors text-xl">‚öôÔ∏è</button>
            </div>
            <p class="text-indigo-400 mb-8 font-medium italic">WAVE DEFENSE SYSTEM ACTIVE üî´</p>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div onclick="window.selectWeapon('VULCAN')" id="card-VULCAN" class="weapon-card p-4 bg-slate-800 rounded-2xl border-2 border-transparent cursor-pointer">
                    <span class="text-3xl">üéØ</span>
                    <div class="font-black text-xs mt-2 uppercase">Vulcan</div>
                </div>
                <div onclick="window.selectWeapon('STRIKER')" id="card-STRIKER" class="weapon-card p-4 bg-slate-800 rounded-2xl border-2 border-transparent cursor-pointer">
                    <span class="text-3xl">üöÄ</span>
                    <div class="font-black text-xs mt-2 uppercase">Striker</div>
                </div>
                <div onclick="window.selectWeapon('ION')" id="card-ION" class="weapon-card p-4 bg-slate-800 rounded-2xl border-2 border-transparent cursor-pointer">
                    <span class="text-3xl">‚ö°</span>
                    <div class="font-black text-xs mt-2 uppercase">Ion Beam</div>
                </div>
                <div onclick="window.selectWeapon('TITAN')" id="card-TITAN" class="weapon-card p-4 bg-slate-800 rounded-2xl border-2 border-transparent cursor-pointer">
                    <span class="text-3xl">üí•</span>
                    <div class="font-black text-xs mt-2 uppercase">Titan</div>
                </div>
            </div>

            <button id="startBtn" onclick="window.startGame()" disabled class="w-full py-5 mb-4 font-black text-2xl rounded-2xl bg-slate-700 text-slate-400 transition-all">PICK A WEAPON</button>
            <button onclick="window.showShop()" class="w-full py-3 font-bold text-slate-300 bg-slate-800 rounded-xl hover:bg-slate-700 transition-all">OPEN ARMORY</button>
        </div>
    </div>

    <!-- Settings Menu -->
    <div id="settingsUI" class="absolute inset-0 hidden flex items-center justify-center bg-black/90 z-[70]">
        <div class="bg-slate-900 p-8 rounded-3xl border border-white/10 w-[350px] text-center">
            <h2 class="text-2xl font-black mb-6">SETTINGS</h2>
            <div class="space-y-6">
                <div>
                    <div class="flex justify-between text-xs font-bold mb-2 uppercase text-slate-400">
                        <span>Master Volume</span>
                        <span id="volVal">50%</span>
                    </div>
                    <input type="range" id="volSlider" min="0" max="100" value="50" oninput="window.updateVolume(this.value)" class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
            <button onclick="window.toggleSettings()" class="mt-8 w-full py-3 rounded-xl bg-indigo-600 font-bold">DONE</button>
        </div>
    </div>

    <!-- Shop (Armory) -->
    <div id="shopUI" class="absolute inset-0 hidden flex items-center justify-center bg-black/90 z-[60]">
        <div class="bg-slate-950 p-8 rounded-[2rem] border-2 border-indigo-500/20 w-full max-w-md shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-black text-indigo-400 italic tracking-widest">ARMORY</h2>
                <div class="bg-yellow-400/10 text-yellow-400 px-4 py-1 rounded-full font-black border border-yellow-400/20" id="shopMoneyDisplay">$0</div>
            </div>
            <div class="space-y-3">
                <div class="bg-slate-900/50 p-4 rounded-2xl flex justify-between items-center border border-white/5 hover:border-indigo-500/40 transition-colors">
                    <div>
                        <div class="font-bold text-emerald-400 flex items-center gap-2">Wingman Drone <span class="text-[10px] bg-emerald-500/20 px-2 py-0.5 rounded text-emerald-300">BOT</span></div>
                        <div id="wingmanCost" class="text-sm font-black text-slate-400">$5,000</div>
                    </div>
                    <button onclick="window.buyItem('wingman')" class="bg-emerald-600 hover:bg-emerald-500 px-6 py-2 rounded-xl font-bold transition-all active:scale-95">BUY</button>
                </div>
                <div class="bg-slate-900/50 p-4 rounded-2xl flex justify-between items-center border border-white/5 hover:border-blue-500/40 transition-colors">
                    <div>
                        <div id="dmgLevelDisplay" class="font-bold text-blue-400">Power Core Lv.1</div>
                        <div id="dmgCost" class="text-sm font-black text-slate-400">$2,500</div>
                    </div>
                    <button onclick="window.buyItem('dmg')" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-xl font-bold transition-all active:scale-95">UPGRADE</button>
                </div>
                <div class="bg-slate-900/50 p-4 rounded-2xl flex justify-between items-center border border-white/5 hover:border-pink-500/40 transition-colors">
                    <div>
                        <div class="font-bold text-pink-400">Rapid Fire Mod</div>
                        <div id="rateCost" class="text-sm font-black text-slate-400">$3,000</div>
                    </div>
                    <button onclick="window.buyItem('rate')" class="bg-pink-600 hover:bg-pink-500 px-6 py-2 rounded-xl font-bold transition-all active:scale-95">UPGRADE</button>
                </div>
            </div>
            <button onclick="window.closeShop()" class="mt-8 w-full py-4 rounded-2xl bg-slate-800 text-slate-300 border border-white/5 hover:bg-slate-700 transition-all font-bold">BACK TO COMMAND</button>
        </div>
    </div>

    <!-- Evolution (Level Up) -->
    <div id="levelUpUI" class="absolute inset-0 hidden flex flex-col items-center justify-center bg-black/95 z-50 p-6 text-center">
        <h2 class="text-6xl font-black text-yellow-400 mb-2 italic animate-pulse">EVOLUTION</h2>
        <p class="text-indigo-300 mb-8 font-bold">SELECT A PATH UPGRADE</p>
        <div id="optionsContainer" class="flex flex-col gap-4 w-full max-w-md"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // State Variables
        let db, auth, user, gameActive = false, money = 0, xp = 0, nextLevelXp = 1000, level = 1;
        let wave = 1, waveProgress = 0, bossActive = false, selectedWeapon = null, masterVol = 0.5;
        
        // Resetting upgrades every run as requested
        let upgrades = { 
            playerFireRate: 1, 
            playerDmg: 1, 
            wingmen: [], 
            piercing: false, 
            cluster: false, 
            chain: false, 
            mega: false 
        };
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const state = { 
            shake: 0, lastShot: 0, stars: [], bullets: [], 
            asteroids: [], particles: [], 
            player: { x: 0, y: 0, tx: 0, ty: 0, r: 18, shield: false }, 
            boss: null 
        };

        const WEAPONS = {
            VULCAN: { rate: 120, color: '#818cf8', bulletSpeed: 20 },
            STRIKER: { rate: 650, color: '#f472b6', bulletSpeed: 10, seeking: true },
            ION: { rate: 900, color: '#22d3ee', bulletSpeed: 40, laser: true },
            TITAN: { rate: 600, color: '#fbbf24', bulletSpeed: 14 }
        };

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(f, t, d, v=0.05) {
            if(audioCtx.state === 'suspended') return;
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
            o.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + d);
            g.gain.setValueAtTime(v * masterVol * 2, audioCtx.currentTime); o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime+d);
        }

        const sounds = {
            VULCAN: () => playSfx(400, 'square', 0.1),
            STRIKER: () => playSfx(200, 'sawtooth', 0.2),
            ION: () => playSfx(800, 'sine', 0.3),
            TITAN: () => playSfx(150, 'triangle', 0.15),
            EXPLODE: () => playSfx(100, 'sawtooth', 0.4, 0.1),
            LEVEL: () => playSfx(600, 'sine', 0.8, 0.15),
            BOSS_SHOT: () => playSfx(120, 'square', 0.2, 0.08)
        };

        // --- FIREBASE INIT ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'asteroid-empire-storm';
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else { await signInAnonymously(auth); }
                };
                initAuth();

                onAuthStateChanged(auth, u => {
                    user = u;
                    if (user) {
                        const savePath = doc(db, 'artifacts', appId, 'users', user.uid, 'saveData', 'global');
                        onSnapshot(savePath, (snap) => {
                            if (snap.exists()) {
                                const data = snap.data();
                                money = data.money || 0;
                                updateHUD(); updateShopUI();
                            }
                        });
                    }
                });
            } catch(e) { console.error("Firebase fail", e); }
        }

        async function saveMoney() {
            if (!user || !db) return;
            const savePath = doc(db, 'artifacts', appId, 'users', user.uid, 'saveData', 'global');
            await setDoc(savePath, { money }, { merge: true });
        }

        // --- CORE LOGIC ---
        function spawnEnemy() {
            if (bossActive) return;
            const roll = Math.random();
            let type = "NORMAL";
            if (roll < 0.1) type = "SPEEDER";
            else if (roll < 0.15 + (wave * 0.01)) type = "ELITE";

            const config = {
                NORMAL: { r: 20, hp: 1 + (wave * 0.5), s: 2 + Math.random()*2, color: '#94a3b8', reward: 100, xp: 150 },
                SPEEDER: { r: 12, hp: 0.5 + (wave * 0.2), s: 6 + Math.random()*3, color: '#f87171', reward: 250, xp: 300 },
                ELITE: { r: 35, hp: 5 + (wave * 2), s: 1 + Math.random()*1, color: '#fbbf24', reward: 600, xp: 1000 }
            };

            const c = config[type];
            state.asteroids.push({ x: Math.random()*canvas.width, y: -50, ...c, type });
        }

        function spawnBoss() {
            bossActive = true;
            document.getElementById('warningOverlay').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('warningOverlay').style.display = 'none';
                document.getElementById('bossBarContainer').style.display = 'block';
                state.boss = {
                    x: canvas.width / 2, y: -200, ty: 120,
                    r: 90, hp: 100 + (wave * 50), maxHp: 100 + (wave * 50),
                    lastShot: 0, lastAimedShot: 0, phase: 0, angleOffset: 0
                };
            }, 2500);
        }

        function updateHUD() {
            document.getElementById('moneyDisplay').innerText = `$${money.toLocaleString()}`;
            document.getElementById('shopMoneyDisplay').innerText = `$${money.toLocaleString()}`;
            document.getElementById('waveDisplay').innerText = `WAVE ${wave}`;
            document.getElementById('progressBar').style.width = `${(xp/nextLevelXp)*100}%`;
            if (state.boss) {
                document.getElementById('bossBar').style.width = `${(state.boss.hp / state.boss.maxHp) * 100}%`;
            }
        }

        function updateShopUI() {
            document.getElementById('wingmanCost').innerText = `$${(5000 * (upgrades.wingmen.length + 1)).toLocaleString()}`;
            document.getElementById('dmgLevelDisplay').innerText = `Power Core Lv.${upgrades.playerDmg}`;
            document.getElementById('dmgCost').innerText = `$${(2500 * upgrades.playerDmg).toLocaleString()}`;
            document.getElementById('rateCost').innerText = `$${(Math.floor(3000 * upgrades.playerFireRate)).toLocaleString()}`;
        }

        // --- UI EXPORTS ---
        window.toggleSettings = () => {
            const ui = document.getElementById('settingsUI');
            ui.classList.toggle('hidden');
        };

        window.updateVolume = (val) => {
            masterVol = val / 100;
            document.getElementById('volVal').innerText = val + '%';
        };

        window.selectWeapon = (id) => {
            selectedWeapon = id;
            document.querySelectorAll('.weapon-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('card-' + id).classList.add('selected');
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = false;
            startBtn.innerText = "ENGAGE WAVE";
            startBtn.className = "w-full py-5 mb-4 font-black text-2xl rounded-2xl bg-indigo-600 text-white shadow-xl hover:scale-105 transition-all";
            if(audioCtx.state === 'suspended') audioCtx.resume();
        };

        window.startGame = () => {
            if(!selectedWeapon) return;
            // Full Reset per-run
            gameActive = true; xp = 0; level = 1; wave = 1; waveProgress = 0; bossActive = false; state.boss = null;
            upgrades = { playerFireRate: 1, playerDmg: 1, wingmen: [], piercing: false, cluster: false, chain: false, mega: false };
            state.bullets = []; state.asteroids = []; state.particles = [];
            state.player.x = canvas.width/2; state.player.y = canvas.height*0.8;
            state.player.tx = state.player.x; state.player.ty = state.player.y; state.player.shield = false;
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('bossBarContainer').style.display = 'none';
            initStars(); updateHUD(); updateShopUI(); loop();
        };

        window.showShop = () => {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            updateShopUI();
            document.getElementById('shopUI').classList.remove('hidden');
        };
        
        window.closeShop = () => document.getElementById('shopUI').classList.add('hidden');

        window.buyItem = (type) => {
            let cost = 0;
            if (type === 'wingman') {
                cost = 5000 * (upgrades.wingmen.length + 1);
                if (money >= cost) {
                    const side = upgrades.wingmen.length % 2 === 0 ? 1 : -1;
                    const dist = 50 + (Math.floor(upgrades.wingmen.length/2) * 30);
                    upgrades.wingmen.push({ ox: dist * side, oy: 30, lastShot: 0 });
                    money -= cost;
                }
            } else if (type === 'dmg') {
                cost = 2500 * upgrades.playerDmg;
                if (money >= cost) {
                    upgrades.playerDmg++;
                    money -= cost;
                }
            } else if (type === 'rate') {
                cost = Math.floor(3000 * upgrades.playerFireRate);
                if (money >= cost) {
                    upgrades.playerFireRate += 0.2;
                    money -= cost;
                }
            }
            saveMoney(); updateHUD(); updateShopUI();
        };

        function initStars() {
            state.stars = [];
            for(let i=0; i<100; i++) state.stars.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*2 + 1 });
        }

        function handleLevelUp() {
            sounds.LEVEL(); gameActive = false;
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            // Custom Path Options based on weapon
            const pathOptions = {
                VULCAN: { name: "üéØ Piercing Rounds", desc: "Bullets pass through 1 enemy", run: () => upgrades.piercing = true },
                STRIKER: { name: "üöÄ Cluster Missiles", desc: "Missiles split on hit", run: () => upgrades.cluster = true },
                ION: { name: "‚ö° Chain Lightning", desc: "Beam arcs to nearby targets", run: () => upgrades.chain = true },
                TITAN: { name: "üí• Mega Blast", desc: "Huge explosion radius", run: () => upgrades.mega = true }
            };

            const opts = [
                pathOptions[selectedWeapon],
                { name: "üõ°Ô∏è Plasma Shield", desc: "Passive protection", run: () => state.player.shield = true },
                { name: "üîã Battery Overload", desc: "Instant Fire Rate +50%", run: () => upgrades.playerFireRate *= 1.5 }
            ];

            opts.forEach(o => {
                const div = document.createElement('div');
                div.className = "bg-slate-900/80 p-6 rounded-2xl cursor-pointer hover:bg-indigo-900 transition-all border-2 border-indigo-500/20 active:scale-95";
                div.innerHTML = `<div class="font-black text-xl text-white mb-1">${o.name}</div><div class="text-xs text-indigo-300 font-bold uppercase">${o.desc}</div>`;
                div.onclick = () => { o.run(); document.getElementById('levelUpUI').classList.add('hidden'); gameActive = true; loop(); };
                container.appendChild(div);
            });
            document.getElementById('levelUpUI').classList.remove('hidden');
        }

        // --- GAME LOOP ---
        function loop() {
            if (!gameActive) return;
            const now = Date.now();
            ctx.fillStyle = '#020617'; ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (!bossActive) {
                waveProgress += 0.05;
                if (waveProgress > 100) {
                    if (wave % 5 === 0) spawnBoss();
                    else { wave++; waveProgress = 0; }
                }
                if (Math.random() < 0.02 + (wave * 0.005)) spawnEnemy();
            }

            if (state.shake > 0) { ctx.save(); ctx.translate((Math.random()-0.5)*state.shake, (Math.random()-0.5)*state.shake); state.shake *= 0.9; }

            state.stars.forEach(s => { s.y += s.s + (wave * 0.1); if(s.y > canvas.height) s.y = 0; ctx.fillStyle = '#ffffff22'; ctx.fillRect(s.x, s.y, 2, 2); });

            state.player.x += (state.player.tx - state.player.x) * 0.15;
            state.player.y += (state.player.ty - state.player.y) * 0.15;

            const wp = WEAPONS[selectedWeapon];
            if (now - state.lastShot > (wp.rate / upgrades.playerFireRate)) {
                sounds[selectedWeapon]();
                const d = upgrades.playerDmg;
                if (selectedWeapon === 'VULCAN') state.bullets.push({ x: state.player.x, y: state.player.y-20, vx: (Math.random()-0.5)*2, vy: -wp.bulletSpeed, c: wp.color, d, p: upgrades.piercing });
                if (selectedWeapon === 'STRIKER') state.bullets.push({ x: state.player.x, y: state.player.y-20, vx: 0, vy: -wp.bulletSpeed, c: wp.color, d: d*1.5, seeking: true, cluster: upgrades.cluster });
                if (selectedWeapon === 'ION') state.bullets.push({ x: state.player.x, y: state.player.y-40, vx: 0, vy: -wp.bulletSpeed, c: wp.color, d: d*3, laser: true, chain: upgrades.chain });
                if (selectedWeapon === 'TITAN') {
                    for(let i=0; i<5; i++) state.bullets.push({ x: state.player.x, y: state.player.y-20, vx: (i-2)*4, vy: -wp.bulletSpeed, c: wp.color, d: d*0.7, mega: upgrades.mega });
                }
                state.lastShot = now;
            }

            upgrades.wingmen.forEach(wm => {
                if (now - (wm.lastShot || 0) > 500) {
                    state.bullets.push({ x: state.player.x + wm.ox, y: state.player.y + wm.oy, vx: 0, vy: -18, c: '#34d399', d: upgrades.playerDmg });
                    wm.lastShot = now;
                }
            });

            if (state.boss) {
                const b = state.boss; b.y += (b.ty - b.y) * 0.02; b.x += Math.sin(now * 0.002) * 3;
                if (now - b.lastShot > 150) {
                    b.angleOffset += 0.2;
                    for(let i=0; i<3; i++) {
                        const angle = (i/3) * Math.PI * 2 + b.angleOffset;
                        state.particles.push({ x: b.x, y: b.y, vx: Math.cos(angle)*5, vy: Math.sin(angle)*5, r: 6, enemy: true, c: '#f87171' });
                    }
                    b.lastShot = now; sounds.BOSS_SHOT();
                }
                if (now - b.lastAimedShot > 2000) {
                    const angleToPlayer = Math.atan2(state.player.y - b.y, state.player.x - b.x);
                    for(let i=-1; i<=1; i++) {
                        const a = angleToPlayer + (i * 0.2);
                        state.particles.push({ x: b.x, y: b.y, vx: Math.cos(a) * 8, vy: Math.sin(a) * 8, r: 10, enemy: true, c: '#ef4444' });
                    }
                    b.lastAimedShot = now; state.shake = 10;
                }
                ctx.strokeStyle = '#7f1d1d'; ctx.lineWidth = 12; ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.stroke();
                ctx.fillStyle = '#0f172a'; ctx.fill();
                const pulse = Math.sin(now * 0.01) * 10;
                ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(b.x, b.y, b.r - 30 + pulse, 0, Math.PI*2); ctx.fill();
                if (b.hp <= 0) {
                    money += 5000; xp += 3000; wave++; waveProgress = 0; bossActive = false; state.boss = null;
                    document.getElementById('bossBarContainer').style.display = 'none';
                    state.shake = 60; sounds.EXPLODE(); updateHUD(); saveMoney();
                }
            }

            state.bullets.forEach(b => {
                if(b.seeking && state.asteroids.length > 0) {
                    const target = state.asteroids[0];
                    const angle = Math.atan2(target.y - b.y, target.x - b.x);
                    b.vx += Math.cos(angle); b.vy += Math.sin(angle);
                }
                b.x += b.vx; b.y += b.vy;
            });

            state.asteroids.forEach(a => a.y += a.s);
            state.particles.forEach(p => { p.x += p.vx; p.y += p.vy; });

            state.asteroids.forEach((a, ai) => {
                if (Math.hypot(state.player.x - a.x, state.player.y - a.y) < state.player.r + a.r) {
                    if (state.player.shield) { state.player.shield = false; state.asteroids.splice(ai, 1); state.shake = 20; }
                    else { gameActive = false; document.getElementById('menu').classList.remove('hidden'); }
                }
                state.bullets.forEach((b, bi) => {
                    if (Math.hypot(b.x - a.x, b.y - a.y) < a.r + 10) {
                        a.hp -= b.d;
                        if(b.cluster) { // Striker Path
                            for(let i=0; i<3; i++) state.bullets.push({x:a.x, y:a.y, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, c:b.c, d:b.d/2});
                        }
                        if(b.mega) state.shake = 15; // Titan Path
                        if (!b.laser && !b.p) state.bullets.splice(bi, 1);
                        if (a.hp <= 0) {
                            money += a.reward; xp += a.xp; state.asteroids.splice(ai, 1);
                            sounds.EXPLODE(); updateHUD(); saveMoney();
                            if(xp >= nextLevelXp) { level++; xp = 0; nextLevelXp *= 1.5; handleLevelUp(); }
                        }
                    }
                });
            });

            if (state.boss) {
                state.bullets.forEach((b, bi) => {
                    if (Math.hypot(b.x - state.boss.x, b.y - state.boss.y) < state.boss.r) {
                        state.boss.hp -= b.d; if(!b.laser && !b.p) state.bullets.splice(bi, 1);
                        updateHUD();
                    }
                });
            }

            state.particles.forEach((p, pi) => {
                if (p.enemy && Math.hypot(state.player.x - p.x, state.player.y - p.y) < state.player.r + p.r) {
                    if (state.player.shield) { state.player.shield = false; state.particles.splice(pi, 1); state.shake = 15; }
                    else { gameActive = false; document.getElementById('menu').classList.remove('hidden'); }
                }
            });

            state.bullets = state.bullets.filter(b => b.y > -200 && b.y < canvas.height + 200);
            state.asteroids = state.asteroids.filter(a => a.y < canvas.height + 100);
            state.particles = state.particles.filter(p => p.y < canvas.height + 200 && p.y > -200);

            state.bullets.forEach(b => { 
                ctx.fillStyle = b.c; 
                if(b.laser) ctx.fillRect(b.x-8, b.y, 16, 200);
                else { ctx.beginPath(); ctx.arc(b.x, b.y, b.mega ? 15 : 5, 0, Math.PI*2); ctx.fill(); }
            });

            state.asteroids.forEach(a => {
                ctx.strokeStyle = a.color; ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(a.x, a.y, a.r, 0, Math.PI*2); ctx.stroke();
                ctx.fillStyle = '#1e293b'; ctx.fill();
            });

            state.particles.forEach(p => { 
                ctx.fillStyle = p.c; ctx.beginPath(); ctx.arc(p.x, p.y, p.r || 2, 0, Math.PI*2); ctx.fill(); 
                if(p.enemy) { ctx.strokeStyle = 'white'; ctx.lineWidth = 1; ctx.stroke(); }
            });

            if (state.player.shield) { 
                ctx.strokeStyle = '#60a5fa'; ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(state.player.x, state.player.y, 35, 0, Math.PI*2); ctx.stroke(); 
            }
            
            ctx.fillStyle = '#6366f1'; 
            ctx.beginPath(); ctx.moveTo(state.player.x, state.player.y-25); ctx.lineTo(state.player.x+20, state.player.y+15); ctx.lineTo(state.player.x-20, state.player.y+15); ctx.fill();

            if (state.shake > 0) ctx.restore();
            requestAnimationFrame(loop);
        }

        function handleInput(e) {
            const rect = canvas.getBoundingClientRect();
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            state.player.tx = cx - rect.left; state.player.ty = cy - rect.top;
        }

        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
        window.addEventListener('mousemove', handleInput);
        window.addEventListener('touchstart', handleInput);
        window.addEventListener('touchmove', (e) => { e.preventDefault(); handleInput(e); }, {passive: false});
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    </script>
</body>
</html>